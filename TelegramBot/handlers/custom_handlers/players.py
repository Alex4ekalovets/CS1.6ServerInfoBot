"""ĞœĞ¾Ğ´ÑƒĞ»ÑŒ Ğ´Ğ»Ñ Ğ¾Ğ±Ñ€Ğ°Ğ±Ğ¾Ñ‚ĞºĞ¸ ĞºĞ¾Ğ¼Ğ°Ğ½Ğ´ Ğ±Ğ¾Ñ‚Ñƒ.

Functions:
    show_servers_players:
        ĞŸĞ¾ĞºĞ°Ğ·Ñ‹Ğ²Ğ°ĞµÑ‚ ĞºĞ¾Ğ»Ğ¸Ñ‡ĞµÑÑ‚Ğ²Ğ¾ Ğ¸Ğ³Ñ€Ğ¾ĞºĞ¾Ğ² Ğ½Ğ° ÑĞµÑ€Ğ²ĞµÑ€Ğµ.
    auto_update_on:
        Ğ—Ğ°Ğ¿ÑƒÑĞºĞ°ĞµÑ‚ Ğ°Ğ²Ñ‚Ğ¾Ğ¾Ğ±Ğ½Ğ¾Ğ²Ğ»ĞµĞ½Ğ¸Ğµ ĞºĞ¾Ğ»Ğ¸Ñ‡ĞµÑÑ‚Ğ²Ğ° Ğ¸Ğ³Ñ€Ğ¾ĞºĞ¾Ğ² Ğ½Ğ° ÑĞµÑ€Ğ²ĞµÑ€Ğµ
    auto_update_off:
        ĞÑ‚ĞºĞ»ÑÑ‡Ğ°ĞµÑ‚ Ğ°Ğ²Ñ‚Ğ¾Ğ¾Ğ±Ğ½Ğ¾Ğ²Ğ»ĞµĞ½Ğ¸Ğµ ĞºĞ¾Ğ»Ğ¸Ñ‡ĞµÑÑ‚Ğ²Ğ° Ğ¸Ğ³Ñ€Ğ¾ĞºĞ¾Ğ² Ğ½Ğ° ÑĞµÑ€Ğ²ĞµÑ€Ğµ
    show_players_after_changes:
        ĞŸĞ¾ĞºĞ°Ğ·Ñ‹Ğ²Ğ°ĞµÑ‚ ĞºĞ¾Ğ»Ğ¸Ñ‡ĞµÑÑ‚Ğ²Ğ¾ Ğ¸Ğ³Ñ€Ğ¾ĞºĞ¾Ğ², ĞµÑĞ»Ğ¸ Ğ¾Ğ½Ğ¾ Ğ¸Ğ·Ğ¼ĞµĞ½Ğ¸Ğ»Ğ¾ÑÑŒ
"""
import time

from telebot.types import Message

from loader import bot

from Server.players import player_on_server, ServerStatus

from utils.logging import logger


@bot.message_handler(commands=["players"])
def show_servers_players(message: Message) -> None:
    """ĞŸĞ¾ĞºĞ°Ğ·Ñ‹Ğ²Ğ°ĞµÑ‚ ĞºĞ¾Ğ»Ğ¸Ñ‡ĞµÑÑ‚Ğ²Ğ¾ Ğ¸Ğ³Ñ€Ğ¾ĞºĞ¾Ğ² Ğ½Ğ° ÑĞµÑ€Ğ²ĞµÑ€Ğµ."""
    try:
        players = player_on_server()
    except Exception as ex:
        logger.error(f'ĞÑˆĞ¸Ğ±ĞºĞ° Ğ¿Ñ€Ğ¸ Ğ¾Ğ±Ñ€Ğ°Ñ‰ĞµĞ½Ğ¸Ğ¸ Ğº ÑĞµÑ€Ğ²ĞµÑ€Ñƒ {ex}')
    else:
        players_names = '\n'.join(players['names'])
        bot.send_message(
            message.chat.id,
            f"ğŸ‘¨â€ğŸ¦³: {players['players_count']} ğŸ¤–: {players['bots_count']}\n"
            f"{players_names}"
        )


@bot.message_handler(commands=["auto_update_on"])
def auto_update_on(message: Message) -> None:
    """
    Ğ—Ğ°Ğ¿ÑƒÑĞºĞ°ĞµÑ‚ Ğ°Ğ²Ñ‚Ğ¾Ğ¾Ğ±Ğ½Ğ¾Ğ²Ğ»ĞµĞ½Ğ¸Ğµ ĞºĞ¾Ğ»Ğ¸Ñ‡ĞµÑÑ‚Ğ²Ğ° Ğ¸Ğ³Ñ€Ğ¾ĞºĞ¾Ğ² Ğ½Ğ° ÑĞµÑ€Ğ²ĞµÑ€Ğµ.

    Ğ—Ğ°Ğ¿ÑƒÑĞºĞ°ĞµÑ‚ÑÑ Ğ¿Ğ¾ Ñ‚Ğ°Ğ¹Ğ¼ĞµÑ€Ñƒ Ğ¾Ğ´Ğ½Ğ¾Ğ³Ğ¾ Ñ‡Ğ°Ñ‚Ğ°, Ğ½Ğ¾ Ğ²Ñ‹Ğ²Ğ¾Ğ´Ğ¸Ñ‚ Ğ¸Ğ½Ñ„Ğ¾Ñ€Ğ¼Ğ°Ñ†Ğ¸Ñ Ğ²Ğ¾ Ğ²ÑĞµÑ… Ñ‡Ğ°Ñ‚Ğ°Ñ…, Ğ³Ğ´Ğµ Ğ²ĞºĞ»ÑÑ‡ĞµĞ½Ğ¾ Ğ°Ğ²Ñ‚Ğ¾Ğ¾Ğ±Ğ½Ğ¾Ğ²Ğ»ĞµĞ½Ğ¸Ğµ
    """
    ServerStatus.chats_id_auto_update.add(message.chat.id)
    logger.info(f"Ğ§Ğ°Ñ‚Ğ¾Ğ² Ñ Ğ°Ğ²Ñ‚Ğ¾Ğ¾Ğ±Ğ½Ğ¾Ğ²Ğ»ĞµĞ½Ğ¸ĞµĞ¼: {len(ServerStatus.chats_id_auto_update)}")
    if len(ServerStatus.chats_id_auto_update) == 1:
        while True:
            show_players_after_changes()
            if len(ServerStatus.chats_id_auto_update) == 0:
                logger.info("ĞĞ²Ñ‚Ğ¾Ğ¾Ğ±Ğ½Ğ¾Ğ²Ğ»ĞµĞ½Ğ¸Ğµ Ğ¾Ñ‚ĞºĞ»ÑÑ‡ĞµĞ½Ğ¾")
                break
            time.sleep(10)


@bot.message_handler(commands=["auto_update_off"])
def auto_update_off(message: Message) -> None:
    """ĞÑ‚ĞºĞ»ÑÑ‡Ğ°ĞµÑ‚ Ğ°Ğ²Ñ‚Ğ¾Ğ¾Ğ±Ğ½Ğ¾Ğ²Ğ»ĞµĞ½Ğ¸Ğµ ĞºĞ¾Ğ»Ğ¸Ñ‡ĞµÑÑ‚Ğ²Ğ° Ğ¸Ğ³Ñ€Ğ¾ĞºĞ¾Ğ² Ğ½Ğ° ÑĞµÑ€Ğ²ĞµÑ€Ğµ."""
    if message.chat.id in ServerStatus.chats_id_auto_update:
        ServerStatus.chats_id_auto_update.remove(message.chat.id)
        logger.info(f"Ğ§Ğ°Ñ‚Ğ¾Ğ² Ñ Ğ°Ğ²Ñ‚Ğ¾Ğ¾Ğ±Ğ½Ğ¾Ğ²Ğ»ĞµĞ½Ğ¸ĞµĞ¼: {len(ServerStatus.chats_id_auto_update)}")


def show_players_after_changes():
    """ĞŸĞ¾ĞºĞ°Ğ·Ñ‹Ğ²Ğ°ĞµÑ‚ ĞºĞ¾Ğ»Ğ¸Ñ‡ĞµÑÑ‚Ğ²Ğ¾ Ğ¸Ğ³Ñ€Ğ¾ĞºĞ¾Ğ², ĞµÑĞ»Ğ¸ Ğ¾Ğ½Ğ¾ Ğ¸Ğ·Ğ¼ĞµĞ½Ğ¸Ğ»Ğ¾ÑÑŒ."""
    try:
        players = player_on_server()
    except Exception as ex:
        logger.error(f'ĞÑˆĞ¸Ğ±ĞºĞ° Ğ¿Ñ€Ğ¸ Ğ¾Ğ±Ñ€Ğ°Ñ‰ĞµĞ½Ğ¸Ğ¸ Ğº ÑĞµÑ€Ğ²ĞµÑ€Ñƒ {ex}')
    else:
        if ServerStatus.players != players['names']:
            for chat_id in ServerStatus.chats_id_auto_update:
                if len(ServerStatus.players) > len(players['names']):
                    icon = "ğŸ“ˆ"
                else:
                    icon = "ğŸ“‰"
                ServerStatus.players = players['names']
                players_names = '\n'.join(players['names'])
                bot.send_message(
                    chat_id,
                    f"ğŸ‘¨â€ğŸ¦³: {players['players_count']} {icon}\n"
                    f"{players_names}"
                )
                logger.success(f"ĞĞ°Ğ¿Ñ€Ğ°Ğ²Ğ»ĞµĞ½ Ğ¾Ñ‚Ğ²ĞµÑ‚ Ğ² Ñ‡Ğ°Ñ‚ Ñ id: {chat_id}")
